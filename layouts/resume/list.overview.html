{{ define "head" }}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ProfilePage",
    "mainEntity": {
      "@type": "Person",
      "name": {{ .Site.Params.author.name | default .Site.Title | jsonify }},
      "url": {{ .Permalink | jsonify }}
    },
    "headline": {{ .Title | jsonify }},
    "description": {{ with .Params.description }}{{ . | jsonify }}{{ else }}{{ .Summary | plainify | jsonify }}{{ end }}
  }
  </script>
  <style>
    .resume-section-toggle {
      cursor: pointer;
      user-select: none;
      position: relative;
      transition: color 0.2s ease;
    }
    .resume-section-toggle:hover {
      color: #3b82f6;
    }
    .toggle-icon {
      font-size: 0.8em;
      margin-left: 0.5rem;
      transition: transform 0.3s ease;
      display: inline-block;
    }
    .resume-section-toggle.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }
    .resume-section-detail-content {
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      max-height: 1000px;
      opacity: 1;
    }
    .resume-section-detail-content.collapsed {
      max-height: 0 !important;
      opacity: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
      display: none !important;
      visibility: hidden !important;
      height: 0 !important;
    }
    
    /* 更强制性的隐藏规则 */
    .prose .resume-section-detail-content.collapsed {
      display: none !important;
      max-height: 0 !important;
      opacity: 0 !important;
      overflow: hidden !important;
    }
    .resume-section-description {
      font-style: italic;
      color: #666;
      margin: 0.5rem 0 1rem 0;
      padding: 0.75rem 1rem;
      background: #f8f9fa;
      border-left: 3px solid #3b82f6;
      border-radius: 0 6px 6px 0;
      font-size: 0.95em;
      line-height: 1.5;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .resume-section-description:before {
      content: "💡 ";
      margin-right: 0.25rem;
    }
    
    /* 响应式布局 - 使用显示/隐藏控制 */
    @media (min-width: 768px) {
      article .resume-header-container-pc {
        display: flex !important;
      }
      article .resume-header-container-mobile {
        display: none !important;
      }
    }
    
    @media (max-width: 767px) {
      article .resume-header-container-pc {
        display: none !important;
      }
      article .resume-header-container-mobile {
        display: flex !important;
      }
    }
  </style>
{{ end }}

{{ define "main" }}
  <article>
    <header>
      <h1 class="mb-6 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral" id="resume-title" style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 0.5rem;">
        {{ .Title | emojify }}
        <span id="global-toggle-icon" style="font-size: 0.6em; transition: transform 0.3s ease;">▶</span>
      </h1>
      <!-- PC端布局 -->
      <div class="resume-header-container-pc" style="display: flex !important; align-items: flex-start !important; gap: 1.5rem !important; margin-bottom: 1.5rem !important; flex-direction: row !important;">
        {{ with .Params.avatar }}
          <img src="{{ . }}" alt="avatar" class="rounded-md object-cover border border-neutral-300 shadow-sm dark:border-neutral-600" style="height: 12rem !important; width: 9rem !important; max-width: 100%; flex-shrink: 0 !important; display: block !important;" />
        {{ end }}
        <div style="flex: 1 !important; min-width: 0 !important; display: block !important;">
          <h2 style="margin: 0 0 1rem 0 !important; font-size: 1.5rem !important; font-weight: 600 !important; color: inherit !important;">👤 基本信息</h2>
          <ul style="margin: 0 !important; padding-left: 1.5rem !important; list-style-type: disc !important;">
            {{ with .Params.basic_info }}
              <li style="margin-bottom: 0.5rem !important; color: inherit !important;"><strong style="font-weight: 600 !important;">姓名</strong>：{{ .name }}</li>
              <li style="margin-bottom: 0.5rem !important; color: inherit !important;"><strong style="font-weight: 600 !important;">职位</strong>：{{ .position }}</li>
              <li style="margin-bottom: 0.5rem !important; color: inherit !important;"><strong style="font-weight: 600 !important;">邮箱</strong>：{{ .email }}</li>
              <li style="margin-bottom: 0.5rem !important; color: inherit !important;"><strong style="font-weight: 600 !important;">GitHub</strong>：{{ .github }}</li>
            {{ end }}
          </ul>
        </div>
      </div>
      
      <!-- 移动端布局 -->
      <div class="resume-header-container-mobile" style="display: flex !important; align-items: center !important; gap: 1.5rem !important; margin-bottom: 1.5rem !important; flex-direction: column !important;">
        {{ with .Params.avatar }}
          <img src="{{ . }}" alt="avatar" class="rounded-md object-cover border border-neutral-300 shadow-sm dark:border-neutral-600" style="height: 8rem !important; width: 6rem !important; max-width: 100%; flex-shrink: 0 !important; display: block !important;" />
        {{ end }}
        <div style="flex: 1 !important; min-width: 0 !important; display: block !important; width: 100% !important; text-align: center !important;">
          <h2 style="margin: 0 0 1rem 0 !important; font-size: 1.5rem !important; font-weight: 600 !important; color: inherit !important;">👤 基本信息</h2>
          <ul style="margin: 0 !important; padding-left: 1.5rem !important; list-style-type: disc !important;">
            {{ with .Params.basic_info }}
              <li style="margin-bottom: 0.5rem !important; color: inherit !important;"><strong style="font-weight: 600 !important;">姓名</strong>：{{ .name }}</li>
              <li style="margin-bottom: 0.5rem !important; color: inherit !important;"><strong style="font-weight: 600 !important;">职位</strong>：{{ .position }}</li>
              <li style="margin-bottom: 0.5rem !important; color: inherit !important;"><strong style="font-weight: 600 !important;">邮箱</strong>：{{ .email }}</li>
              <li style="margin-bottom: 0.5rem !important; color: inherit !important;"><strong style="font-weight: 600 !important;">GitHub</strong>：{{ .github }}</li>
            {{ end }}
          </ul>
        </div>
      </div>
    </header>

    <section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row">
      {{ if in .TableOfContents "<ul" }}
        <div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8">
          <div class="toc pe-5 lg:sticky lg:top-10 print:hidden">
            {{ partial "toc.html" . }}
          </div>
        </div>
      {{ end }}
      <div class="min-h-0 min-w-0 max-w-prose grow">
        {{ .Content | emojify }}
      </div>
    </section>
  </article>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Resume script loaded');
      
      // 响应式布局控制
      function updateLayout() {
        const pcContainer = document.querySelector('.resume-header-container-pc');
        const mobileContainer = document.querySelector('.resume-header-container-mobile');
        
        if (window.innerWidth >= 768) {
          // PC端：显示PC布局，隐藏移动端布局
          if (pcContainer) pcContainer.style.display = 'flex';
          if (mobileContainer) mobileContainer.style.display = 'none';
        } else {
          // 移动端：显示移动端布局，隐藏PC布局
          if (pcContainer) pcContainer.style.display = 'none';
          if (mobileContainer) mobileContainer.style.display = 'flex';
        }
      }
      
      // 初始设置
      updateLayout();
      
      // 监听窗口大小变化
      window.addEventListener('resize', updateLayout);
      
      // 全局展开/收缩功能
      let isAllExpanded = false;
      const resumeTitle = document.getElementById('resume-title');
      const globalToggleIcon = document.getElementById('global-toggle-icon');
      
      if (resumeTitle && globalToggleIcon) {
        // 添加悬停效果
        resumeTitle.addEventListener('mouseenter', function() {
          resumeTitle.style.color = 'var(--color-primary)';
        });
        
        resumeTitle.addEventListener('mouseleave', function() {
          resumeTitle.style.color = '';
        });
        
        // 点击事件
        resumeTitle.addEventListener('click', function() {
          isAllExpanded = !isAllExpanded;
          console.log('Global toggle clicked, isAllExpanded:', isAllExpanded);
          
          // 获取所有可展开的元素
          const allDetailContents = document.querySelectorAll('.resume-section-detail-content');
          const allToggleIcons = document.querySelectorAll('.toggle-icon');
          const allDescriptionDivs = document.querySelectorAll('.resume-section-description');
          
          allDetailContents.forEach((detailContent, index) => {
            const toggleIcon = allToggleIcons[index];
            const descriptionDiv = allDescriptionDivs[index];
            
            if (isAllExpanded) {
              // 全部展开
              detailContent.classList.remove('collapsed');
              detailContent.style.display = 'block';
              detailContent.style.maxHeight = 'none';
              detailContent.style.opacity = '1';
              detailContent.style.overflow = 'visible';
              detailContent.style.visibility = 'visible';
              
              if (toggleIcon) {
                toggleIcon.textContent = '▼';
                toggleIcon.style.transform = 'rotate(0deg)';
              }
              
              if (descriptionDiv) {
                descriptionDiv.style.display = 'none';
              }
            } else {
              // 全部收缩
              detailContent.classList.add('collapsed');
              detailContent.style.display = 'none';
              detailContent.style.maxHeight = '0';
              detailContent.style.opacity = '0';
              detailContent.style.overflow = 'hidden';
              detailContent.style.visibility = 'hidden';
              
              if (toggleIcon) {
                toggleIcon.textContent = '▶';
                toggleIcon.style.transform = 'rotate(0deg)';
              }
              
              if (descriptionDiv) {
                descriptionDiv.style.display = 'block';
              }
            }
          });
          
          // 更新全局图标
          globalToggleIcon.textContent = isAllExpanded ? '▼' : '▶';
          globalToggleIcon.style.transform = isAllExpanded ? 'rotate(0deg)' : 'rotate(0deg)';
          
          console.log('Global toggle completed, isAllExpanded:', isAllExpanded);
        });
      }
      
      // 隐藏Markdown渲染的基本信息部分（在prose容器内的）
      const proseContainer = document.querySelector('.prose');
      if (proseContainer) {
        const basicInfoH2 = proseContainer.querySelector('h2');
        if (basicInfoH2 && basicInfoH2.textContent.includes('基本信息')) {
          let nextElement = basicInfoH2.nextElementSibling;
          while (nextElement && nextElement.tagName !== 'H2') {
            nextElement.style.display = 'none';
            nextElement = nextElement.nextElementSibling;
          }
          basicInfoH2.style.display = 'none';
          console.log('Hidden original basic info section in prose container');
        }
      }
      
      // 处理三级标题的展开/折叠（技术栈部分）
      const h3Elements = document.querySelectorAll('h3');
      console.log('Found h3 elements:', h3Elements.length);
      
      h3Elements.forEach((h3, index) => {
        console.log(`Processing h3 ${index}:`, h3.textContent);
        
        // 检查是否是工作经历部分的三级标题，如果是则跳过（工作经历用四级标题）
        const isWorkExperience = h3.textContent.includes('工程师') || h3.textContent.includes('工作经历');
        if (isWorkExperience) {
          console.log('Skipping work experience h3:', h3.textContent);
          return;
        }
        
        // 1. 找到该标题下的所有内容（直到下一个h2或h3）
        const allContent = [];
        let currentElement = h3.nextElementSibling;
        
        while (currentElement && currentElement.tagName !== 'H3' && currentElement.tagName !== 'H2') {
          allContent.push(currentElement);
          currentElement = currentElement.nextElementSibling;
        }
        
        console.log(`Found ${allContent.length} content elements for h3 ${index}`);
        
        // 2. 识别第一个包含<em>的<p>标签作为描述
        let descriptionElement = null;
        let descriptionText = '';
        
        for (let i = 0; i < allContent.length; i++) {
          const element = allContent[i];
          console.log(`Checking element ${i}:`, element.tagName, element.textContent.substring(0, 50));
          if (element.tagName === 'P' && element.querySelector('em')) {
            descriptionElement = element;
            descriptionText = element.querySelector('em').textContent;
            console.log('Found description:', descriptionText);
            break;
          }
        }
        
        // 3. 如果找到描述，则处理展开/折叠功能
        if (descriptionElement && descriptionText) {
          console.log('Setting up toggle for:', h3.textContent);
          // 创建可点击的标题
          h3.style.cursor = 'pointer';
          h3.style.userSelect = 'none';
          
          // 添加展开/折叠图标
          const toggleIcon = document.createElement('span');
          toggleIcon.textContent = '▶';
          toggleIcon.style.marginLeft = '0.5rem';
          toggleIcon.style.transition = 'transform 0.3s ease';
          toggleIcon.style.display = 'inline-block';
          h3.appendChild(toggleIcon);
          
          // 创建描述容器
          const descriptionDiv = document.createElement('div');
          descriptionDiv.className = 'resume-section-description';
          descriptionDiv.textContent = descriptionText;
          
          // 创建详细内容容器
          const detailContentDiv = document.createElement('div');
          detailContentDiv.className = 'resume-section-detail-content';
          
          // 4. 将除描述段落外的所有内容移动到详细内容容器
          allContent.forEach(element => {
            if (element !== descriptionElement) {
              detailContentDiv.appendChild(element);
            }
          });
          
          // 5. 重新组织DOM结构
          // 移除原始的描述段落
          h3.parentNode.removeChild(descriptionElement);
          
          // 插入描述容器和详细内容容器
          h3.parentNode.insertBefore(descriptionDiv, currentElement);
          h3.parentNode.insertBefore(detailContentDiv, currentElement);
          
          // 默认简略模式（只显示描述）
          let isDetailed = false;
          
          // 立即应用默认状态
          setTimeout(() => {
            detailContentDiv.classList.add('collapsed');
            detailContentDiv.style.display = 'none';
            detailContentDiv.style.maxHeight = '0';
            detailContentDiv.style.opacity = '0';
            detailContentDiv.style.overflow = 'hidden';
            toggleIcon.style.transform = 'rotate(0deg)';
            descriptionDiv.style.display = 'block';
            console.log('Applied default collapsed state for:', h3.textContent);
            console.log('Detail content div classes:', detailContentDiv.className);
            console.log('Detail content div style:', detailContentDiv.style.cssText);
          }, 0);
          
          // 点击事件
          h3.addEventListener('click', function() {
            isDetailed = !isDetailed;
            console.log('Toggle clicked for:', h3.textContent, 'isDetailed:', isDetailed);
            
            if (isDetailed) {
              // 详细模式：显示详细内容，隐藏描述
              detailContentDiv.classList.remove('collapsed');
              detailContentDiv.style.display = 'block';
              detailContentDiv.style.maxHeight = 'none';
              detailContentDiv.style.opacity = '1';
              detailContentDiv.style.overflow = 'visible';
              detailContentDiv.style.visibility = 'visible';
              toggleIcon.textContent = '▼';
              toggleIcon.style.transform = 'rotate(0deg)';
              descriptionDiv.style.display = 'none';
              console.log('Switched to detailed mode');
            } else {
              // 简略模式：只显示描述，隐藏详细内容
              detailContentDiv.classList.add('collapsed');
              detailContentDiv.style.display = 'none';
              detailContentDiv.style.maxHeight = '0';
              detailContentDiv.style.opacity = '0';
              detailContentDiv.style.overflow = 'hidden';
              detailContentDiv.style.visibility = 'hidden';
              toggleIcon.textContent = '▶';
              toggleIcon.style.transform = 'rotate(0deg)';
              descriptionDiv.style.display = 'block';
              console.log('Switched to simple mode');
            }
          });
          
          // 悬停效果
          h3.addEventListener('mouseenter', function() {
            h3.style.color = 'var(--color-primary)';
          });
          
          h3.addEventListener('mouseleave', function() {
            h3.style.color = '';
          });
        }
      });
      
      // 处理四级标题的展开/折叠（工作经历项目部分）
      const h4Elements = document.querySelectorAll('h4');
      console.log('Found h4 elements:', h4Elements.length);
      
      h4Elements.forEach((h4, index) => {
        console.log(`Processing h4 ${index}:`, h4.textContent);
        
        // 检查是否是工作经历项目的四级标题
        const isProjectTitle = h4.textContent.includes('）') && (h4.textContent.includes('项目') || h4.textContent.includes('服务'));
        if (!isProjectTitle) {
          console.log('Skipping non-project h4:', h4.textContent);
          return;
        }
        
        // 1. 找到该标题下的所有内容（直到下一个h2、h3或h4）
        const allContent = [];
        let currentElement = h4.nextElementSibling;
        
        while (currentElement && currentElement.tagName !== 'H4' && currentElement.tagName !== 'H3' && currentElement.tagName !== 'H2') {
          allContent.push(currentElement);
          currentElement = currentElement.nextElementSibling;
        }
        
        console.log(`Found ${allContent.length} content elements for h4 ${index}`);
        
        // 2. 识别第一个包含<em>的<p>标签作为描述
        let descriptionElement = null;
        let descriptionText = '';
        
        for (let i = 0; i < allContent.length; i++) {
          const element = allContent[i];
          console.log(`Checking h4 element ${i}:`, element.tagName, element.textContent.substring(0, 50));
          if (element.tagName === 'P' && element.querySelector('em')) {
            descriptionElement = element;
            descriptionText = element.querySelector('em').textContent;
            console.log('Found h4 description:', descriptionText);
            break;
          }
        }
        
        // 3. 如果找到描述，则处理展开/折叠功能
        if (descriptionElement && descriptionText) {
          console.log('Setting up toggle for h4:', h4.textContent);
          // 创建可点击的标题
          h4.style.cursor = 'pointer';
          h4.style.userSelect = 'none';
          
          // 添加展开/折叠图标
          const toggleIcon = document.createElement('span');
          toggleIcon.textContent = '▶';
          toggleIcon.style.marginLeft = '0.5rem';
          toggleIcon.style.transition = 'transform 0.3s ease';
          toggleIcon.style.display = 'inline-block';
          h4.appendChild(toggleIcon);
          
          // 创建描述容器
          const descriptionDiv = document.createElement('div');
          descriptionDiv.className = 'resume-section-description';
          descriptionDiv.textContent = descriptionText;
          
          // 创建详细内容容器
          const detailContentDiv = document.createElement('div');
          detailContentDiv.className = 'resume-section-detail-content';
          
          // 4. 将除描述段落外的所有内容移动到详细内容容器
          allContent.forEach(element => {
            if (element !== descriptionElement) {
              detailContentDiv.appendChild(element);
            }
          });
          
          // 5. 重新组织DOM结构
          // 移除原始的描述段落
          h4.parentNode.removeChild(descriptionElement);
          
          // 插入描述容器和详细内容容器
          h4.parentNode.insertBefore(descriptionDiv, currentElement);
          h4.parentNode.insertBefore(detailContentDiv, currentElement);
          
          // 默认简略模式（只显示描述）
          let isDetailed = false;
          
          // 立即应用默认状态
          setTimeout(() => {
            detailContentDiv.classList.add('collapsed');
            detailContentDiv.style.display = 'none';
            detailContentDiv.style.maxHeight = '0';
            detailContentDiv.style.opacity = '0';
            detailContentDiv.style.overflow = 'hidden';
            toggleIcon.style.transform = 'rotate(0deg)';
            descriptionDiv.style.display = 'block';
            console.log('Applied default collapsed state for h4:', h4.textContent);
          }, 0);
          
          // 点击事件
          h4.addEventListener('click', function() {
            isDetailed = !isDetailed;
            console.log('Toggle clicked for h4:', h4.textContent, 'isDetailed:', isDetailed);
            
            if (isDetailed) {
              // 详细模式：显示详细内容，隐藏描述
              detailContentDiv.classList.remove('collapsed');
              detailContentDiv.style.display = 'block';
              detailContentDiv.style.maxHeight = 'none';
              detailContentDiv.style.opacity = '1';
              detailContentDiv.style.overflow = 'visible';
              detailContentDiv.style.visibility = 'visible';
              toggleIcon.textContent = '▼';
              toggleIcon.style.transform = 'rotate(0deg)';
              descriptionDiv.style.display = 'none';
              console.log('Switched to detailed mode for h4');
            } else {
              // 简略模式：只显示描述，隐藏详细内容
              detailContentDiv.classList.add('collapsed');
              detailContentDiv.style.display = 'none';
              detailContentDiv.style.maxHeight = '0';
              detailContentDiv.style.opacity = '0';
              detailContentDiv.style.overflow = 'hidden';
              detailContentDiv.style.visibility = 'hidden';
              toggleIcon.textContent = '▶';
              toggleIcon.style.transform = 'rotate(0deg)';
              descriptionDiv.style.display = 'block';
              console.log('Switched to simple mode for h4');
            }
          });
          
          // 悬停效果
          h4.addEventListener('mouseenter', function() {
            h4.style.color = 'var(--color-primary)';
          });
          
          h4.addEventListener('mouseleave', function() {
            h4.style.color = '';
          });
        }
      });
    });
  </script>
{{ end }}
